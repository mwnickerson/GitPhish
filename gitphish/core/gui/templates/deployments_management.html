{% extends "base.html" %}

{% block page_title %}Deployments Management{% endblock %}

{% block content %}
<!-- Notification Area (moved to top) -->
<div id="deploy-alert-area" class="mb-3"></div>
<div class="row">
    <div class="col-md-8">
        <!-- Deployment Accounts Management (moved first) -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fab fa-github me-2"></i>Deployment Accounts
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 mb-3">
                    <button type="button" id="add-account-btn" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                        <i class="fas fa-plus me-2"></i>Add GitHub Account
                    </button>
                    <button type="button" id="refresh-accounts-btn" class="btn btn-secondary">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
                <ul class="list-group" id="deployment-accounts-list">
                    <li class="list-group-item text-muted">No deployment accounts</li>
                </ul>
            </div>
        </div>
        <!-- GitHub Pages Deployments (moved second) -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fab fa-github me-2"></i>GitHub Pages Deployments
                </h5>
            </div>
            <div class="card-body">
                <!-- Quick Deploy Controls -->
                <div class="d-flex gap-2 mb-3">
                    <button type="button" id="start-deploy-btn" class="btn btn-success">
                        <i class="fas fa-play me-2"></i>Start Deployment
                    </button>
                    <button type="button" id="check-status-btn" class="btn btn-info">
                        <i class="fas fa-sync-alt me-2"></i>Check Status
                    </button>
                </div>
                <!-- Deploy Configuration -->
                <form id="deploy-config-form" class="mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="account_id" class="form-label">Deployment Account</label>
                                <select class="form-select" id="account_id" name="account_id" required>
                                    <option value="">Select account...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="repo_name" class="form-label">Repository Name</label>
                                <input type="text" class="form-control" id="repo_name" name="repo_name" placeholder="e.g. verification-portal" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ingest_url" class="form-label">Ingest URL</label>
                                <input type="text" class="form-control" id="ingest_url" name="ingest_url" placeholder="https://yourserver/ingest" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="repo_description" class="form-label">Repository Description</label>
                                <input type="text" class="form-control" id="repo_description" name="repo_description" placeholder="GitHub Verification Portal" value="GitHub Verification Portal">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="preset" class="form-label">Preset</label>
                                <select class="form-select" id="preset" name="preset">
                                    <option value="default">Default</option>
                                    <option value="enterprise">Enterprise</option>
                                    <option value="urgent">Urgent</option>
                                    <option value="security">Security</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="custom_title" class="form-label">Custom Title</label>
                                <input type="text" class="form-control" id="custom_title" name="custom_title" placeholder="Optional">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="org_name" class="form-label">Organization Name</label>
                                <input type="text" class="form-control" id="org_name" name="org_name" placeholder="Optional">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="poll_deployment" name="poll_deployment" checked>
                                <label class="form-check-label" for="poll_deployment">Poll Deployment</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="poll_timeout" class="form-label">Poll Timeout (seconds)</label>
                                <input type="number" class="form-control" id="poll_timeout" name="poll_timeout" value="300" min="60" max="3600">
                            </div>
                        </div>
                    </div>
                </form>
                <!-- Active Deployments Table -->
                <div>
                    <h6>Active Deployments</h6>
                    <table class="table deployments-table table-striped align-middle">
                        <thead>
                            <tr>
                                <th>Repository</th>
                                <th>Status</th>
                                <th>Deployed At</th>
                                <th>Page Link</th>
                                <th class="text-center">Health</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="active-deployments-table">
                            <tr>
                                <td colspan="6" class="text-muted">No active deployments</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-trash-alt me-2"></i>Danger Zone
                </h5>
            </div>
            <div class="card-body">
                <button type="button" id="delete-all-deployments-btn" class="btn btn-danger w-100 mb-2">
                    <i class="fas fa-trash me-2"></i>Delete All Deployments
                </button>
                <button type="button" id="refresh-deployments-btn" class="btn btn-secondary w-100">
                    <i class="fas fa-sync-alt me-2"></i>Refresh Deployments
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Account Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1" aria-labelledby="addAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAccountModalLabel">Add GitHub Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="add-account-form">
          <div class="mb-3">
            <label for="github-token-input" class="form-label">GitHub Account Token</label>
            <input type="text" class="form-control" id="github-token-input" name="github-token-input" required autocomplete="off">
            <div class="invalid-feedback" id="add-account-error"></div>
          </div>
          <button type="submit" class="btn btn-primary">Add Account</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Remove Account Confirmation Modal -->
<div class="modal fade" id="removeAccountModal" tabindex="-1" aria-labelledby="removeAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="removeAccountModalLabel">Remove Deployment Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to remove this deployment account?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-remove-account-btn">Remove</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Deployment Confirmation Modal -->
<div class="modal fade" id="deleteDeploymentModal" tabindex="-1" aria-labelledby="deleteDeploymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteDeploymentModalLabel">Delete Deployment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete the deployment for <span id="delete-deployment-repo-name" class="fw-bold"></span>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-deployment-btn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete All Deployments Confirmation Modal -->
<div class="modal fade" id="deleteAllDeploymentsModal" tabindex="-1" aria-labelledby="deleteAllDeploymentsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteAllDeploymentsModalLabel">Delete All Deployments</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <span id="delete-all-count" class="fw-bold"></span> deployments? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-all-deployments-btn">Delete All</button>
      </div>
    </div>
  </div>
</div>

<style>
.deployments-table {
    background-color: #23243a; /* Match card/page background */
    color: #f8f9fa;
}
.deployments-table th,
.deployments-table td {
    background-color: transparent !important;
    color: #f8f9fa;
}
.deployments-table .btn-info, .deployments-table .btn-danger {
    color: #fff;
}
#deployment-accounts-list img {
    border: 1px solid #444;
    background: #23243a;
}
#deployment-accounts-list .badge {
    font-size: 0.85em;
    vertical-align: middle;
}
#deployment-accounts-list .validate-account-btn {
    min-width: 90px;
}
.health-indicator {
    display: inline-block;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #aaa;
    background: transparent;
    vertical-align: middle;
    cursor: pointer;
    transition: background 0.2s, border 0.2s;
}
.health-indicator.health-live {
    background: #2ecc71;
    border-color: #2ecc71;
}
.health-indicator.health-down {
    background: transparent;
    border-color: #e74c3c;
}
.health-indicator.health-loading {
    background: repeating-linear-gradient(45deg, #aaa, #aaa 5px, #fff 5px, #fff 10px);
    border-color: #aaa;
}
.health-indicator.health-error {
    background: #e74c3c;
    border-color: #e74c3c;
}
.health-indicator.health-unknown {
    background: transparent;
    border-color: #aaa;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// --- Deployments Management JS ---

document.addEventListener('DOMContentLoaded', function() {
    // Initial load
    fetchDeployments();
    fetchAccounts();
    populateAccountDropdown();

    // --- Deployments ---
    document.getElementById('start-deploy-btn').addEventListener('click', function(e) {
        e.preventDefault();
        startDeployment();
    });
    document.getElementById('check-status-btn').addEventListener('click', fetchDeployments);
    document.getElementById('refresh-deployments-btn').addEventListener('click', fetchDeployments);

    // --- Accounts ---
    document.getElementById('refresh-accounts-btn').addEventListener('click', fetchAccounts);

    // Modal form submission for adding account
    document.getElementById('add-account-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const tokenInput = document.getElementById('github-token-input');
        const errorDiv = document.getElementById('add-account-error');
        const token = tokenInput.value.trim();
        errorDiv.textContent = '';
        tokenInput.classList.remove('is-invalid');
        if (!token) {
            errorDiv.textContent = 'Token is required.';
            tokenInput.classList.add('is-invalid');
            return;
        }
        fetch('/api/github/accounts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert('Account added', 'success');
                fetchAccounts();
                populateAccountDropdown();
                // Hide modal
                const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addAccountModal'));
                modal.hide();
                tokenInput.value = '';
            } else {
                errorDiv.textContent = data.error || 'Failed to add account';
                tokenInput.classList.add('is-invalid');
            }
        })
        .catch(() => {
            errorDiv.textContent = 'Failed to add account';
            tokenInput.classList.add('is-invalid');
        });
    });

    // Reset Add Account modal when closed
    const addAccountModal = document.getElementById('addAccountModal');
    addAccountModal.addEventListener('hidden.bs.modal', function() {
        const tokenInput = document.getElementById('github-token-input');
        const errorDiv = document.getElementById('add-account-error');
        tokenInput.value = '';
        tokenInput.classList.remove('is-invalid');
        errorDiv.textContent = '';
    });

    document.getElementById('delete-all-deployments-btn').addEventListener('click', openDeleteAllDeploymentsModal);
    document.getElementById('confirm-delete-all-deployments-btn').addEventListener('click', deleteAllDeployments);
});

// Fetch and display deployments
function fetchDeployments() {
    fetch('/api/deployment/status')
        .then(r => r.json())
        .then(data => {
            const all = (data.active_deployments || []).concat(data.recent_deployments || []);
            const seen = new Set();
            const filtered = all.filter(dep => {
                const isActive = ['pending', 'in_progress', 'active'].includes((dep.status || '').toLowerCase());
                if (!isActive) return false;
                if (seen.has(dep.id)) return false;
                seen.add(dep.id);
                return true;
            });
            updateActiveDeploymentsTable(filtered);
        })
        .catch(() => showAlert('Failed to fetch deployments', 'danger'));
}

// Start a deployment
function startDeployment() {
    const form = document.getElementById('deploy-config-form');
    const accountId = document.getElementById('account_id').value;
    const repoName = document.getElementById('repo_name').value.trim();
    const ingestUrl = document.getElementById('ingest_url').value.trim();
    const repoDescription = document.getElementById('repo_description').value.trim() || 'GitHub Verification Portal';
    const preset = document.getElementById('preset').value;
    const customTitle = document.getElementById('custom_title').value.trim();
    const orgName = document.getElementById('org_name').value.trim();
    const pollDeployment = document.getElementById('poll_deployment').checked;
    const pollTimeout = parseInt(document.getElementById('poll_timeout').value, 10) || 300;

    if (!accountId || !repoName || !ingestUrl) {
        showAlert('Missing required fields', 'warning');
        return;
    }

    const payload = {
        account_id: accountId,
        repo_name: repoName,
        ingest_url: ingestUrl,
        repo_description: repoDescription,
        template_preset: preset,
        custom_title: customTitle || undefined,
        org_name: orgName || undefined,
        poll_deployment: pollDeployment,
        poll_timeout: pollTimeout
    };

    fetch('/api/deployment/deploy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            fetchDeployments();
        } else {
            showAlert(data.error || 'Failed to start deployment', 'danger');
        }
    })
    .catch(() => showAlert('Failed to start deployment', 'danger'));
}

// Populate the account dropdown with available accounts
function populateAccountDropdown() {
    fetch('/api/github/accounts')
        .then(r => r.json())
        .then(accounts => {
            const select = document.getElementById('account_id');
            select.innerHTML = '<option value="">Select account...</option>';
            accounts.forEach(acc => {
                const opt = document.createElement('option');
                opt.value = acc.id;
                opt.textContent = acc.username || acc.login || ('Account #' + acc.id);
                select.appendChild(opt);
            });
        });
}

// Update active deployments table
function updateActiveDeploymentsTable(list) {
    const tbody = document.getElementById('active-deployments-table');
    tbody.innerHTML = '';
    if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-muted">No active deployments</td></tr>';
        return;
    }
    list.forEach(dep => {
        const tr = document.createElement('tr');
        // Each deployment gets a unique health id
        const healthId = `health-indicator-${dep.id}`;
        tr.innerHTML = `
            <td class="text-light">${dep.repo_name}</td>
            <td class="text-light">${dep.status}</td>
            <td class="text-light">${dep.deployed_at || ''}</td>
            <td class="text-light">${dep.pages_url ? `<a href="${dep.pages_url}" target="_blank" rel="noopener" class="text-info">${dep.pages_url}</a>` : '<span class="text-muted">&mdash;</span>'}</td>
            <td class="text-center">
                <span class="health-indicator" id="${healthId}" data-deployment-id="${dep.id}" title="Click to check health"></span>
            </td>
            <td class="text-center">
                <div class="d-flex justify-content-center align-items-center gap-2 mx-auto" style="width: max-content;">
                    <button class="btn btn-sm btn-danger delete-deployment-btn" data-repo-name="${dep.repo_name}" data-bs-toggle="modal" data-bs-target="#deleteDeploymentModal">Delete</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
    // Attach click handlers for delete buttons
    tbody.querySelectorAll('.delete-deployment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            deploymentToDelete = this.getAttribute('data-repo-name');
            document.getElementById('delete-deployment-repo-name').textContent = deploymentToDelete;
        });
    });
    // Attach click handlers for health indicators and load health on first render
    tbody.querySelectorAll('.health-indicator').forEach(span => {
        const deploymentId = span.getAttribute('data-deployment-id');
        // Set initial state to loading and fetch health immediately
        setHealthIndicator(span, 'loading');
        fetch(`/api/deployment/health/${deploymentId}`)
            .then(r => r.json())
            .then(data => {
                if (data.status === 'live') {
                    setHealthIndicator(span, 'live');
                } else {
                    setHealthIndicator(span, 'down');
                }
            })
            .catch(() => setHealthIndicator(span, 'error'));
        // Still allow manual refresh on click
        span.addEventListener('click', function() {
            setHealthIndicator(this, 'loading');
            fetch(`/api/deployment/health/${deploymentId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'live') {
                        setHealthIndicator(this, 'live');
                    } else {
                        setHealthIndicator(this, 'down');
                    }
                })
                .catch(() => setHealthIndicator(this, 'error'));
        });
    });
}

// Helper to set health indicator state
function setHealthIndicator(el, state) {
    if (!el) return;
    el.className = 'health-indicator';
    if (state === 'live') {
        el.classList.add('health-live');
        el.title = 'Deployment is live';
    } else if (state === 'down') {
        el.classList.add('health-down');
        el.title = 'Deployment is not live';
    } else if (state === 'loading') {
        el.classList.add('health-loading');
        el.title = 'Checking health...';
    } else if (state === 'error') {
        el.classList.add('health-error');
        el.title = 'Error checking health';
    } else {
        el.classList.add('health-unknown');
        el.title = 'Health unknown (click to check)';
    }
}

// Track the deployment repo to delete
let deploymentToDelete = null;

// Delete deployment (no confirm)
function deleteDeployment(repoName) {
    fetch(`/api/deployment/delete/${encodeURIComponent(repoName)}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert('Deployment deleted', 'success');
                fetchDeployments();
            } else {
                showAlert(data.error || 'Failed to delete deployment', 'danger');
            }
        })
        .catch(() => showAlert('Failed to delete deployment', 'danger'));
}

// --- Accounts ---
function fetchAccounts() {
    fetch('/api/github/accounts')
        .then(r => r.json())
        .then(list => updateAccounts(list))
        .catch(() => showAlert('Failed to fetch accounts', 'danger'));
}

let accountToRemove = null;
function updateAccounts(list) {
    const ul = document.getElementById('deployment-accounts-list');
    ul.innerHTML = '';
    if (!list.length) {
        ul.innerHTML = '<li class="list-group-item text-muted">No deployment accounts</li>';
        return;
    }
    list.forEach(acc => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2';
        li.innerHTML = `
            <div class="d-flex align-items-center gap-2 flex-grow-1">
                <img src="${acc.avatar_url || 'https://github.com/identicons/default.png'}" class="rounded-circle me-2" width="32" height="32" alt="Avatar">
                <span class="fw-semibold">${acc.username || acc.login || 'Account #' + acc.id}</span>
                <span class="ms-2 badge ${acc.is_valid ? 'bg-success' : 'bg-danger'}">${acc.is_valid ? 'Valid' : 'Invalid'}</span>
                <span class="ms-2 text-muted small">Last validated: ${acc.last_validated_at ? new Date(acc.last_validated_at).toLocaleString() : 'Never'}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-primary validate-account-btn" data-account-id="${acc.id}">
                    <i class="fas fa-check-circle me-1"></i>Validate
                </button>
                <button class="btn btn-sm btn-outline-danger" data-account-id="${acc.id}" data-bs-toggle="modal" data-bs-target="#removeAccountModal">Remove</button>
            </div>
        `;
        ul.appendChild(li);
    });
    // Attach click handlers for remove buttons
    ul.querySelectorAll('button[data-account-id].btn-outline-danger').forEach(btn => {
        btn.addEventListener('click', function() {
            accountToRemove = this.getAttribute('data-account-id');
        });
    });
    // Attach click handlers for validate buttons
    ul.querySelectorAll('button.validate-account-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-account-id');
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Validating';
            fetch(`/api/github/accounts/${id}/validate`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Account validated', 'success');
                        fetchAccounts();
                        populateAccountDropdown();
                    } else {
                        showAlert(data.error || 'Failed to validate account', 'danger');
                    }
                })
                .catch(() => showAlert('Failed to validate account', 'danger'))
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-check-circle me-1"></i>Validate';
                });
        });
    });
}

// Remove account when confirmed in modal
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('confirm-remove-account-btn').addEventListener('click', function() {
        if (!accountToRemove) return;
        fetch(`/api/github/accounts/${accountToRemove}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showAlert('Account removed', 'success');
                    fetchAccounts();
                    populateAccountDropdown();
                } else {
                    showAlert(data.error || 'Failed to remove account', 'danger');
                }
                // Hide modal
                const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('removeAccountModal'));
                modal.hide();
                accountToRemove = null;
            })
            .catch(() => {
                showAlert('Failed to remove account', 'danger');
                const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('removeAccountModal'));
                modal.hide();
                accountToRemove = null;
            });
    });
});

// Danger Zone: Delete all deployments
function openDeleteAllDeploymentsModal() {
    // Count currently displayed deployments
    const tbody = document.getElementById('active-deployments-table');
    const rows = tbody.querySelectorAll('tr');
    // Exclude the 'No active deployments' row
    const deployments = Array.from(rows).filter(tr => tr.querySelector('.delete-deployment-btn'));
    document.getElementById('delete-all-count').textContent = deployments.length;
    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('deleteAllDeploymentsModal'));
    modal.show();
}

function deleteAllDeployments() {
    const tbody = document.getElementById('active-deployments-table');
    const deleteButtons = tbody.querySelectorAll('.delete-deployment-btn');
    if (!deleteButtons.length) {
        showAlert('No deployments to delete', 'info');
        return;
    }
    let deleted = 0;
    let failed = 0;
    let total = deleteButtons.length;
    let completed = 0;
    // Collect repo names to delete
    const repoNames = Array.from(deleteButtons).map(btn => btn.getAttribute('data-repo-name'));
    repoNames.forEach(repoName => {
        fetch(`/api/deployment/delete/${encodeURIComponent(repoName)}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    deleted++;
                } else {
                    failed++;
                }
            })
            .catch(() => {
                failed++;
            })
            .finally(() => {
                completed++;
                if (completed === total) {
                    if (deleted) showAlert(`${deleted} deployment(s) deleted`, 'success');
                    if (failed) showAlert(`${failed} deployment(s) failed to delete`, 'danger');
                    fetchDeployments();
                }
            });
    });
    // Hide modal
    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('deleteAllDeploymentsModal'));
    modal.hide();
}

// Confirm delete deployment from modal
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('confirm-delete-deployment-btn').addEventListener('click', function() {
        if (!deploymentToDelete) return;
        deleteDeployment(deploymentToDelete);
        // Hide modal
        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('deleteDeploymentModal'));
        modal.hide();
        deploymentToDelete = null;
    });
});

// --- Utility ---
function showAlert(msg, type) {
    // type: 'success', 'danger', 'warning', 'info'
    const area = document.getElementById('deploy-alert-area');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${msg}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    area.innerHTML = '';
    area.appendChild(alertDiv);
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (area.contains(alertDiv)) {
            alertDiv.classList.remove('show');
            alertDiv.classList.add('hide');
            setTimeout(() => { if (area.contains(alertDiv)) area.removeChild(alertDiv); }, 500);
        }
    }, 5000);
}
</script>
{% endblock %} 